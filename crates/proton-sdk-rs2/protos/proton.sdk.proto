syntax = "proto3";

package proton.sdk;

import "google/protobuf/any.proto";

option csharp_namespace = "Proton.Sdk.CExports";

message Request {
    oneof payload {
        CancellationTokenSourceCreateRequest cancellation_token_source_create = 100;
        CancellationTokenSourceCancelRequest cancellation_token_source_cancel = 101;
        CancellationTokenSourceFreeRequest cancellation_token_source_free = 102;

        StreamReadRequest stream_read = 200;

        SessionBeginRequest session_begin = 300;
        SessionResumeRequest session_resume = 301;
        SessionRenewRequest session_renew = 302;
        SessionEndRequest session_end = 303;
        SessionTokensRefreshedSubscribeRequest session_tokens_refreshed_subscribe = 304;
        SessionTokensRefreshedUnsubscribeRequest session_tokens_refreshed_unsubscribe = 305;
        SessionFreeRequest session_free = 306;

        LoggerProviderCreate logger_provider_create = 400;
    };
}

message Response {
    oneof result { // Optional, if no return value and no error
        google.protobuf.Any value = 1;
        Error error = 2;
    }
}

message RepeatedBytesValue {
    repeated bytes value = 1;
}

// Cancellation tokens

// The response value must be an Int64Value carrying a handle to an instance of CancellationTokenSource.
message CancellationTokenSourceCreateRequest {}

// The reponse must not have a value.
message CancellationTokenSourceCancelRequest {
    int64 cancellation_token_source_handle = 1;
}

// The reponse must not have a value.
message CancellationTokenSourceFreeRequest {
    int64 cancellation_token_source_handle = 1;
}

// Sessions

// The response value type must be Int64Value.
message SessionBeginRequest {
    string username = 1;
    string password = 2;
    string app_version = 3;
    string secret_cache_path = 4; // Optional
    ProtonClientOptions options = 5; // Optional
    int64 cancellation_token_source_handle = 6;
}

// The response value type must be Int64Value.
message SessionResumeRequest {
    string username = 1;
    string app_version = 2;
    string session_id = 3;
    string user_id = 4;
    string access_token = 5;
    string refresh_token = 6;
    repeated string scopes = 7;
    bool is_waiting_for_second_factor_code = 8;
    bool is_waiting_for_data_password = 9;
    string secret_cache_path = 10;
    ProtonClientOptions options = 11;
}

// The response value type must be Int64Value.
message SessionRenewRequest {
    int64 old_session_handle = 1;
    string session_id = 2;
    string access_token = 3;
    string refresh_token = 4;
    repeated string scopes = 5;
    bool is_waiting_for_second_factor_code = 6;
    bool is_waiting_for_data_password = 7;
}

// The reponse must not have a value.
message SessionEndRequest {
    int64 session_handle = 1;
}

// The response value must be an Int64Value carrying a handle to an instance of TokensRefreshedSubscription.
message SessionTokensRefreshedSubscribeRequest {
    int64 session_handle = 1;
    int64 tokens_refreshed_action = 2;
}

// The reponse must not have a value.
message SessionTokensRefreshedUnsubscribeRequest {
    int64 subscription_handle = 1;
}

// The reponse must not have a value.
message SessionFreeRequest {
    int64 session_handle = 1;
}

// The response value must be an Int64Value carrying a handle to an instance of ILoggerProvider.
message LoggerProviderCreate {
    int64 log_action = 1;
}

message LogEvent {
    int32 level = 1;
    string message = 2;
    string category_name = 3;
}

message MetricEvent {
    string name = 1;
    google.protobuf.Any payload = 2;
}

enum ProtonClientTlsPolicy {
    PROTON_CLIENT_TLS_POLICY_STRICT = 0;
    PROTON_CLIENT_TLS_POLICY_NO_CERTIFICATE_PINNING = 1;
    PROTON_CLIENT_TLS_POLICY_NO_CERTIFICATE_VALIDATION = 2;
}

enum AddressStatus {
    ADDRESS_STATUS_DISABLED = 0;
    ADDRESS_STATUS_ENABLED = 1;
    ADDRESS_STATUS_DELETING = 2;
}

enum DelinquentState {
    DELINQUENT_STATE_PAID = 0;
    DELINQUENT_STATE_AVAILABLE = 1;
    DELINQUENT_STATE_OVERDUE = 2;
    DELINQUENT_STATE_DELINQUENT = 3;
    DELINQUENT_STATE_NOT_RECEIVED = 4;
}

enum UserType {
    USER_TYPE_UNKNOWN = 0;
    USER_TYPE_PROTON = 1;
    USER_TYPE_MANAGED = 2;
    USER_TYPE_EXTERNAL = 3;
}

message Telemetry {
    oneof logger { // Optional
        int64 log_action = 1; // See array_action in C header file for signature
        int64 logger_provider_handle = 2;
    }
    int64 record_metric_action = 3; // Optional, see array_action in C header file for signature
}

message ProtonClientOptions {
    string base_url = 1; // Optional
    string user_agent = 2; // Optional
    string bindings_language = 3; // Optional
    ProtonClientTlsPolicy tls_policy = 4; // Optional
    Telemetry telemetry = 5; // Optional
    string entity_cache_path = 6; // Optional
}

message SessionTokens {
    string access_token = 1;
    string refresh_token = 2;
}

enum ErrorDomain {
    Undefined = 0;
    SuccessfulCancellation = 1;
    Api = 2;
    Network = 3;
    Transport = 4;
    Serialization = 5;
    Cryptography = 6;
    DataIntegrity = 7;
    BusinessLogic = 8;
}

message Error {
    string type = 1;
    string message = 2;
    ErrorDomain domain = 3;
    int64 primary_code = 4; // Optional
    int64 secondary_code = 5; // Optional
    string context = 6; // Optional
    Error inner_error = 7; // Optional
    google.protobuf.Any additional_data = 8; // Optional
}

message Address {
    string address_id = 1;
    int32 order = 2;
    string email_address = 3;
    AddressStatus status = 4;
    repeated proton.sdk.AddressKey keys = 5;
    int32 primary_key_index = 6;
}

message AddressKey {
    string address_id = 1;
    string address_key_id = 2;
    bool is_active = 3;
    bool is_allowed_for_encryption = 4;
    bool is_allowed_for_verification = 5;
}

// The response value must be an Int32Value carrying the number of bytes read into the buffer. That number must not be negative.
message StreamReadRequest {
    int64 stream_handle = 1;
    int64 buffer_pointer = 2;
    int32 buffer_length = 3;
}

// The response value must be an Int64Value carrying the new position in the stream.
message StreamSeekRequest {
    int64 offset = 1;
    int32 origin = 2; // 0 = Begin, 1 = Current, 2 = End (matches SeekOrigin enum)
}

enum HttpRequestType {
    HTTP_REQUEST_TYPE_REGULAR_API = 0;
    HTTP_REQUEST_TYPE_STORAGE_DOWNLOAD = 1;
    HTTP_REQUEST_TYPE_STORAGE_UPLOAD = 2;
}

message HttpHeader {
    string name = 1;
    repeated string values = 2;
}

// The response value must be an HttpResponse.
message HttpRequest {
    HttpRequestType type = 1;
    string url = 2;
    string method = 3;
    repeated HttpHeader headers = 4;
    int64 sdk_content_handle = 5; // Optional, to be used with StreamReadRequest
}

message HttpResponse {
    int32 status_code = 1;
    repeated HttpHeader headers = 2;
    int64 bindings_content_handle = 3; // Optional
}

message ApiRetrySucceededEventPayload {
    string url = 1;
    int32 failed_attempts = 2;
}